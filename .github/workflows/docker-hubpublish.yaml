name: Publish Docker image to Dockerhub
on:
  push:
    branches: master
    tags:
      - "*"
jobs:
  push_to_registry:
    name: Push Docker image to Docker Hub
    if: github.repository == 'sudoinclabs/sudo-docker-openvpn'
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      - name: Build OpenVPN Image
        run: |
          docker build -t openvpn .
      - name: Tag, and push image to DockerHub
        run: |
          docker tag openvpn sudoinclabs/openvpn:latest
          docker push --all-tags sudoinclabs/openvpn
      - name: Get Latest Release
        id: latest_version
        uses: abatilo/release-info-action@v1.3.0
        with:
          owner: abatilo
          repo: release-info-action
      - name: Example of consumption of the output
        env:
          LATEST: ${{ steps.latest_version.outputs.latest_tag }}
          LATEST_DATE: ${{ steps.latest_version.outputs.latest_tag_published_at }}
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          docker tag openvpn sudoinclabs/openvpn:$LATEST
          docker push --all-tags sudoinclabs/openvpn

